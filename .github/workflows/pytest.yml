name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  core:
    name: core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install package and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint (ruff)
        run: |
          ruff check \
            openatoms/api.py \
            scripts/generate_interface_report.py \
            tests/test_public_api_surface.py \
            tests/test_end_to_end_agent_flow.py \
            tests/test_interface_report_up_to_date.py \
            tests/test_thermo_affinity_boundary.py

      - name: Type check (mypy public surface)
        run: mypy --follow-imports=skip openatoms/api.py openatoms/ir/__init__.py

      - name: Pytest
        run: pytest -q

      - name: Interface report check
        run: pytest -q tests/test_interface_report_up_to_date.py

      - name: Bundle reproducibility tests
        run: pytest -q tests/test_bundle_*.py tests/test_repro_docs_up_to_date.py

      - name: Minimal pip install smoke test
        run: |
          python -m venv /tmp/openatoms-install-test
          /tmp/openatoms-install-test/bin/pip install .
          /tmp/openatoms-install-test/bin/python -c "import openatoms; from openatoms import build_protocol, compile_protocol; print(openatoms.__name__)"
          /tmp/openatoms-install-test/bin/openatoms bundle --help

      - name: Examples as tests
        run: pytest -q tests/test_examples_execution.py

      - name: Build distributions
        run: python -m build --no-isolation

      - name: Smoke install from wheel
        run: |
          python -m venv /tmp/openatoms-wheel-test
          /tmp/openatoms-wheel-test/bin/pip install dist/*.whl
          /tmp/openatoms-wheel-test/bin/python -c "from openatoms.ir import load_schema, validate_ir; payload={'ir_version':'1.2.0','protocol_id':'00000000-0000-0000-0000-000000000000','correlation_id':'00000000-0000-0000-0000-000000000001','created_at':'2026-01-01T00:00:00+00:00','steps':[{'step':1,'step_id':'s1','action_type':'Move','parameters':{'amount':{'value':1,'unit':'microliter'}},'depends_on':[],'resources':[]}],'provenance':{'ir_hash':'0'*64,'simulator_versions':{},'noise_seed':None,'validator_version':'1.2.0'}}; print(load_schema()['$id']); assert validate_ir(payload)==payload"

  determinism-cantera:
    name: determinism-cantera
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install package and cantera dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,cantera]"

      - name: Verify reproducibility with cantera enforced
        env:
          OPENATOMS_CI: "1"
        run: python scripts/verify_reproducibility.py

      - name: Real ODE integration tests
        env:
          OPENATOMS_CI: "1"
        run: pytest tests/test_real_ode_integration.py -v

      - name: Ignition delay smoke
        run: python -c "from openatoms.sim.registry.kinetics_sim import VirtualReactor; from openatoms.units import Q_; r = VirtualReactor(); d = r.compute_ignition_delay({'H2': 2.0, 'O2': 1.0, 'N2': 3.76}, Q_(1000, 'kelvin'), Q_(1, 'atm')); assert d['converged'], 'ignition delay did not converge'"

  all-extras-optional:
    name: all-extras-optional
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install package with all extras
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[all]"

      - name: Extras smoke import
        run: python -c "from openatoms.sim.registry import VirtualReactor, RoboticsSimulator, OT2Simulator; print('extras-smoke-ok')"
