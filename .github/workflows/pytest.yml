name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  core:
    name: core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install package and dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Pytest
        run: pytest -q

      - name: Examples as tests
        run: pytest -q tests/test_examples_execution.py

      - name: Build distributions
        run: python -m build --no-isolation

      - name: Smoke install from wheel
        run: |
          python -m venv /tmp/openatoms-wheel-test
          /tmp/openatoms-wheel-test/bin/pip install dist/*.whl
          /tmp/openatoms-wheel-test/bin/python -c "from openatoms.ir import load_schema, validate_ir; payload={'ir_version':'1.1.0','protocol_id':'00000000-0000-0000-0000-000000000000','correlation_id':'00000000-0000-0000-0000-000000000001','created_at':'2026-01-01T00:00:00+00:00','steps':[{'step':1,'step_id':'s1','action_type':'Move','parameters':{'amount':{'value':1,'unit':'microliter'}},'depends_on':[],'resources':[]}],'provenance':{'ir_hash':'0'*64,'simulator_versions':{},'noise_seed':None,'validator_version':'1.1.0'}}; print(load_schema()['$id']); assert validate_ir(payload)==payload"

  determinism-cantera:
    name: determinism-cantera
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.10"

      - name: Install package and cantera dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,sim-cantera]"

      - name: Verify reproducibility with cantera enforced
        env:
          OPENATOMS_CI: "1"
        run: python scripts/verify_reproducibility.py
