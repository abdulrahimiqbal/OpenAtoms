# OpenAtoms Experiment Bundle (OEB) Specification

Version: `1.0`
Status: Stable

The OpenAtoms Experiment Bundle (OEB) is a tamper-evident, replayable artifact format for AI-driven protocol lineage:

`intent -> protocol IR -> safety checks -> optional simulator checks -> execution trace -> results`.

## 1. Goals and Boundaries

### Goals
- Deterministic packaging and replay for the same inputs and seeds.
- Auditability through explicit provenance and file hashing.
- Lightweight signing support for CI/internal provenance.

### Non-goals
- Scientific certification or proof of mechanism validity.
- Replacement for calibrated hardware QA/QC or regulated safety systems.

## 2. Bundle Container

An OEB can be:
- A directory tree, or
- A `.zip` file containing the same internal tree rooted at one directory.

The internal layout MUST match:

```text
bundle_root/
  manifest.json
  protocol.ir.json
  provenance.json
  environment/
    python.txt
    platform.txt
    dependencies.txt
    pyproject.toml
    lockfile.*            # optional
  checks/
    validate.json
    dry_run.json
    simulators/           # optional
      <name>/report.json
  agent/
    tool_calls.jsonl      # optional
    prompts.json          # optional
    model.json            # optional
  execution/
    trace.jsonl           # optional
    instruments.json      # optional
    logs/                 # optional
  results/
    artifacts.json        # optional
    data/                 # optional
    derived/              # optional
```

## 3. Canonical Rules

- JSON files MUST be UTF-8 encoded.
- JSON files generated by OpenAtoms SHOULD be canonicalized with sorted keys and compact separators.
- Relative paths in `manifest.json.file_hashes` use `/` separators.
- `created_at` fields MUST be RFC3339 UTC timestamps.
- Deterministic mode fixes bundle timestamps and enforces sorted ordering for generated collections.

## 4. `manifest.json` (Required)

Required fields:
- `bundle_version`: string, MUST be `"1.0"`.
- `created_at`: RFC3339 UTC timestamp.
- `openatoms_version`: OpenAtoms package version string.
- `openatoms_git_sha`: git commit SHA when available, otherwise `null`.
- `schema_version`: OpenAtoms IR schema version used for `protocol.ir.json` validation.
- `protocol_ir_hash`: SHA-256 hash of raw bytes of `protocol.ir.json`.
- `file_hashes`: object mapping `relative/path -> sha256` for all bundle files except `manifest.json`.
- `seeds`: object containing at least:
  - `python_random`
  - `numpy`
  - `openatoms_internal`
- `simulator_status`: array of objects with:
  - `name`
  - `status` in `{ran, skipped, failed}`
  - `reason` string (required when skipped/failed, optional otherwise)
- `disclaimers`: array of explicit statements separating heuristic checks from validated science.

Optional field:
- `signature`: signature object.

Signature object (when present):
- `algorithm`: e.g. `hmac-sha256`.
- `key_id`: logical key identifier (not secret material).
- `signed_at`: RFC3339 UTC timestamp.
- `value`: signature bytes encoded as lowercase hex.

Signing scope:
- Signature MUST be computed over canonical `manifest.json` content with the `signature` field removed.
- Private keys/secrets MUST NOT be stored in bundle artifacts.

## 5. `provenance.json` (Required)

A lightweight W3C-PROV-inspired model with:
- `agents`: array
- `entities`: array
- `activities`: array
- `relations`: array with relation records of type:
  - `used`
  - `generated`
  - `wasAssociatedWith`

Minimum lineage requirements:
- Agent (human and/or AI) associated with protocol-generation activity.
- Protocol-generation activity generates the IR entity (`protocol.ir.json`).
- Validation activity generates `checks/validate.json`.
- Dry-run activity generates `checks/dry_run.json`.
- Simulator activities generate `checks/simulators/<name>/report.json` when applicable.

## 6. Verification and Replay Requirements

Bundle verification MUST validate:
- Required files exist.
- `bundle_version` compatibility.
- `protocol_ir_hash` correctness.
- All `file_hashes` entries match current file bytes.
- Signature validity when `manifest.signature` exists.

Replay MUST:
- Re-run IR validation.
- Re-run dry-run if executable protocol context is available; otherwise produce deterministic `skipped` outcome.
- Re-run selected simulator checks if configured.
- Compare replayed check reports against recorded reports.
- In strict mode, fail on any replay mismatch.

## 7. Error Taxonomy

OpenAtoms OEB error codes:
- `OEB001`: Missing required file or path.
- `OEB002`: Hash mismatch / tamper evidence failure.
- `OEB003`: Bundle or schema incompatibility.
- `OEB004`: Signature invalid or unverifiable.
- `OEB005`: Replay mismatch.
- `OEB006`: Bundle structure/manifest invalid.

JSON reports from verification/replay SHOULD include:
- `ok` boolean
- `errors` array with `code`, `message`, and optional `path`

## 8. Security and Privacy

- Bundles MUST NOT contain secrets.
- Agent traces (`agent/tool_calls.jsonl`) SHOULD be redacted for obvious secret patterns (API keys, bearer tokens, passwords, access keys).
- Redaction is pattern-based and conservative; operators remain responsible for final review before sharing.

## 9. Compatibility

- Forward compatibility: unknown fields SHOULD be ignored.
- Backward compatibility: major `bundle_version` changes indicate incompatible structure.
- This specification defines `bundle_version = 1.0`.
